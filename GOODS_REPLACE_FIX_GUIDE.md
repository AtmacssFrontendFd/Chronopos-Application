# AddGoodsReplaceViewModel Fix Guide

## Quick Reference for Remaining Compilation Errors

### 1. AppLogger.LogError Signature Fix
**Error**: Argument 2: cannot convert from 'string' to 'System.Exception?'

**Find & Replace** all instances of:
```csharp
AppLogger.LogError("message", ex.Message, "category");
```

**Replace with:**
```csharp
AppLogger.LogError($"message: {ex.Message}", ex, "category");
```

### 2. Event Handler Signatures

**Current (Wrong):**
```csharp
private void OnThemeChanged(object? sender, Theme theme) { }
private void OnZoomChanged(object? sender, ZoomLevel zoomLevel) { }
private void OnLanguageChanged(object? sender, SupportedLanguage language) { }
private void OnPrimaryColorChanged(object? sender, string colorHex) { }
private void OnDirectionChanged(object? sender, Desktop.Services.LayoutDirection direction) { }
private void OnDatabaseLanguageChanged(object? sender, SupportedLanguage language) { }
```

**Replace with (Correct):**
```csharp
private void OnThemeChanged(Theme theme) { }
private void OnZoomChanged(ZoomLevel zoomLevel) { }
private void OnLanguageChanged(SupportedLanguage language) { }
private void OnPrimaryColorChanged(ColorOption colorOption) { }
private void OnDirectionChanged(LayoutDirection direction) 
{
    CurrentFlowDirection = direction switch
    {
        LayoutDirection.LeftToRight => FlowDirection.LeftToRight,
        LayoutDirection.RightToLeft => FlowDirection.RightToLeft,
        _ => FlowDirection.LeftToRight
    };
}
private void OnDatabaseLanguageChanged(object? sender, string languageCode) { }
```

###  3. Service Method Names

**Find:** `await _productService.GetAllAsync();`
**Replace:** `await _productService.GetAllProductsAsync();`

**Find:** `await _uomService.GetAllAsync();`
**Replace:** `await _uomService.GetAllUomsAsync();`

**Find:** `await _productBatchService.GetBatchesByProductAsync(productId);`
**Replace:** `await _productBatchService.GetBatchesByProductIdAsync(productId);`

**Find:** `await _stockService.GetStockByProductAndStoreIdAsync(`
**Replace:** `await _stockService.GetStockByProductAndStoreAsync(`

### 4. GoodsReturnItemDto Property

**Find:** `Rate = item.UnitPrice,`
**Replace:** `Rate = item.CostPrice,`

### 5. CreateGoodsReplaceDto Structure

**Current (Wrong):**
```csharp
var replaceDto = new CreateGoodsReplaceDto
{
    ReplaceNo = ReplaceNo,  // WRONG
    // ...
    TotalAmount = TotalAmount,  // WRONG
    Items = ReplaceItems.Select(item => new GoodsReplaceItemDto  // WRONG type
```

**Replace with (Correct):**
```csharp
var replaceDto = new CreateGoodsReplaceDto
{
    // ReplaceNo is auto-generated by service, don't set it
    SupplierId = (int)SupplierId!.Value,
    StoreId = StoreId!.Value,
    ReferenceReturnId = ReferenceReturnId!.Value,
    ReplaceDate = ReplaceDate,
    // TotalAmount is auto-calculated, don't set it
    Status = saveStatus,
    Remarks = Remarks,
    Items = ReplaceItems.Select(item => new CreateGoodsReplaceItemDto  // Use CreateGoodsReplaceItemDto
    {
        ProductId = item.ProductId!.Value,
        UomId = item.UomId!.Value,
        BatchNo = item.BatchNo,
        ExpiryDate = item.ExpiryDate,
        Quantity = item.Quantity,
        Rate = item.Rate,
        // Amount is auto-calculated, don't set it
        ReferenceReturnItemId = item.ReferenceReturnItemId,
        RemarksLine = item.Remarks
    }).ToList()
};
```

### 6. Type Conversion for ProductId

**Find all instances of:**
```csharp
ProductId = (int?)item.ProductId,  // Cast long to int?
```

**Replace with:**
```csharp
ProductId = item.ProductId,  // No cast needed, already int
```

### 7. StoreId type conversion

**Find:**
```csharp
StoreId = (int?)goodsReturn.StoreId;  // Cast long to int?
```

**Replace:**
```csharp
StoreId = goodsReturn.StoreId;  // Already correct type
```

## Complete Fixed Event Handler Section

Replace the entire `#region Settings Event Handlers` section with:

```csharp
#region Settings Event Handlers

private void OnThemeChanged(Theme theme)
{
    // Reload theme
}

private void OnZoomChanged(ZoomLevel zoomLevel)
{
    // Handle zoom change
}

private void OnLanguageChanged(SupportedLanguage language)
{
    // Reload localized text
    // TODO: Implement localization
}

private void OnPrimaryColorChanged(ColorOption colorOption)
{
    // Handle color change
}

private void OnDirectionChanged(LayoutDirection direction)
{
    CurrentFlowDirection = direction switch
    {
        LayoutDirection.LeftToRight => FlowDirection.LeftToRight,
        LayoutDirection.RightToLeft => FlowDirection.RightToLeft,
        _ => FlowDirection.LeftToRight
    };
}

private void OnDatabaseLanguageChanged(object? sender, string languageCode)
{
    // Reload database text
}

#endregion
```

## After All Fixes

Run: `dotnet build`

The project should build successfully with 0 errors (only warnings are okay).

Then run the application and test:
1. Click "Stock Management" from dashboard
2. Click the "Goods Replace" button (5th button)
3. Click "New Goods Replace" button
4. You should see the Add Goods Replace screen with 3 tabs
5. Fill in the form, select a Reference Return, and items should auto-load
6. Test Save Draft and Post buttons
