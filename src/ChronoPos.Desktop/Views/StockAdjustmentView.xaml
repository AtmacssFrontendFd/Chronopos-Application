<UserControl x:Class="ChronoPos.Desktop.Views.StockAdjustmentView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:vm="clr-namespace:ChronoPos.Desktop.ViewModels"
             xmlns:converters="clr-namespace:ChronoPos.Desktop.Converters"
             xmlns:controls="clr-namespace:ChronoPos.Desktop.Views.Controls"
             mc:Ignorable="d" 
             d:DesignHeight="800" d:DesignWidth="1200"
             d:DataContext="{d:DesignInstance Type=vm:StockAdjustmentViewModel}">

    <UserControl.Resources>
        <!-- Converters -->
        <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibilityConverter"/>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <converters:StringToVisibilityConverter x:Key="StringToVisibilityConverter"/>
    </UserControl.Resources>

    <Grid Background="{DynamicResource BackgroundBrush}">
        
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- Top Button Bar with Back and New Adjustment -->
        <Grid Grid.Row="0" Margin="0,0,0,10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <!-- Back Button -->
            <controls:RefreshButton Grid.Column="0"
                                    HorizontalAlignment="Left"
                                    VerticalAlignment="Top"
                                    ButtonText="Back"
                                    ButtonIcon="â†"
                                    Command="{Binding GoBackCommand}"
                                    ButtonBackground="{DynamicResource SecondaryBrush}"
                                    ButtonForeground="White"
                                    MinButtonWidth="100"
                                    ButtonHeight="36"
                                    ButtonWidth="100" />

            <!-- New Adjustment Button -->
            <controls:RefreshButton Grid.Column="2"
                                    HorizontalAlignment="Right"
                                    VerticalAlignment="Top"
                                    ButtonText="New Adjustment"
                                    ButtonIcon="+"
                                    Command="{Binding CreateNewAdjustmentCommand}"
                                    ButtonBackground="{DynamicResource PrimaryBrush}"
                                    ButtonForeground="White"
                                    MinButtonWidth="140"
                                    ButtonHeight="36"
                                    ButtonWidth="140" />

            <!-- Refresh Button -->
            <controls:RefreshButton Grid.Column="3"
                                    HorizontalAlignment="Right"
                                    VerticalAlignment="Top"
                                    ButtonText="Refresh"
                                    ButtonIcon="ðŸ”„"
                                    Command="{Binding LoadAdjustmentsCommand}"
                                    ButtonBackground="{DynamicResource AccentBrush}"
                                    ButtonForeground="White"
                                    MinButtonWidth="100"
                                    ButtonHeight="36"
                                    ButtonWidth="100"
                                    Margin="10,0,0,0" />
        </Grid>

        <!-- Filter Panel -->
        <Border Grid.Row="1" 
                Background="{DynamicResource CardBackgroundBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="1"
                CornerRadius="5"
                Margin="0,0,0,10"
                Padding="15">
            
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>
                
                <Grid Grid.Row="0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="200" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="200" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="150" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="150" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>

                    <!-- Status Filter -->
                    <TextBlock Grid.Column="0" 
                               Text="Status:" 
                               VerticalAlignment="Center" 
                               Margin="0,0,10,0"
                               Foreground="{DynamicResource ForegroundBrush}" />
                    
                    <ComboBox Grid.Column="1" 
                              ItemsSource="{Binding StatusOptions}"
                              SelectedItem="{Binding SelectedStatus}"
                              Margin="0,0,20,0" />

                    <!-- Store Location Filter -->
                    <TextBlock Grid.Column="2" 
                               Text="Store:" 
                               VerticalAlignment="Center" 
                               Margin="0,0,10,0"
                               Foreground="{DynamicResource ForegroundBrush}" />
                    
                    <ComboBox Grid.Column="3" 
                              ItemsSource="{Binding StoreLocations}"
                              SelectedValue="{Binding SelectedStoreLocationId}"
                              SelectedValuePath="Id"
                              DisplayMemberPath="Name"
                              Margin="0,0,20,0" />

                    <!-- From Date -->
                    <TextBlock Grid.Column="4" 
                               Text="From:" 
                               VerticalAlignment="Center" 
                               Margin="0,0,10,0"
                               Foreground="{DynamicResource ForegroundBrush}" />
                    
                    <DatePicker Grid.Column="5" 
                                SelectedDate="{Binding FromDate}"
                                Margin="0,0,20,0" />

                    <!-- To Date -->
                    <TextBlock Grid.Column="6" 
                               Text="To:" 
                               VerticalAlignment="Center" 
                               Margin="0,0,10,0"
                               Foreground="{DynamicResource ForegroundBrush}" />
                    
                    <DatePicker Grid.Column="7" 
                                SelectedDate="{Binding ToDate}"
                                Margin="0,0,20,0" />
                </Grid>

                <!-- Filter Action Buttons -->
                <StackPanel Grid.Row="1" 
                            Orientation="Horizontal" 
                            HorizontalAlignment="Right"
                            Margin="0,10,0,0">
                    
                    <Button Content="Apply Filters"
                            Command="{Binding ApplyFiltersCommand}"
                            Background="{DynamicResource PrimaryBrush}"
                            Foreground="White"
                            Padding="15,5"
                            Margin="0,0,10,0" />
                    
                    <Button Content="Clear Filters"
                            Command="{Binding ClearFiltersCommand}"
                            Background="{DynamicResource SecondaryBrush}"
                            Foreground="White"
                            Padding="15,5" />
                </StackPanel>
            </Grid>
        </Border>

        <!-- Main Content Area -->
        <Grid Grid.Row="2">
            
            <!-- Stock Adjustments List -->
            <Border Background="{DynamicResource CardBackgroundBrush}"
                    BorderBrush="{DynamicResource BorderBrush}"
                    BorderThickness="1"
                    CornerRadius="5"
                    Visibility="{Binding IsEditing, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <!-- Header -->
                    <Border Grid.Row="0" 
                            Background="{DynamicResource HeaderBackgroundBrush}"
                            Padding="15,10">
                        <TextBlock Text="Stock Adjustments"
                                   FontSize="18"
                                   FontWeight="SemiBold"
                                   Foreground="{DynamicResource HeaderForegroundBrush}" />
                    </Border>

                    <!-- DataGrid -->
                    <DataGrid Grid.Row="1" 
                              ItemsSource="{Binding StockAdjustments}"
                              SelectedItem="{Binding SelectedAdjustment}"
                              AutoGenerateColumns="False"
                              CanUserAddRows="False"
                              CanUserDeleteRows="False"
                              IsReadOnly="True"
                              GridLinesVisibility="Horizontal"
                              Background="{DynamicResource CardBackgroundBrush}"
                              Foreground="{DynamicResource ForegroundBrush}"
                              BorderThickness="0"
                              Margin="15">

                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Adjustment No" 
                                                Binding="{Binding AdjustmentNo}" 
                                                Width="150" />
                            
                            <DataGridTextColumn Header="Date" 
                                                Binding="{Binding AdjustmentDate, StringFormat='{}{0:dd/MM/yyyy}'}" 
                                                Width="100" />
                            
                            <DataGridTextColumn Header="Store Location" 
                                                Binding="{Binding StoreLocationName}" 
                                                Width="150" />
                            
                            <DataGridTextColumn Header="Reason" 
                                                Binding="{Binding ReasonName}" 
                                                Width="120" />
                            
                            <DataGridTextColumn Header="Status" 
                                                Binding="{Binding Status}" 
                                                Width="100" />
                            
                            <DataGridTextColumn Header="Items Count" 
                                                Binding="{Binding TotalItemsCount}" 
                                                Width="100" />
                            
                            <DataGridTextColumn Header="Created By" 
                                                Binding="{Binding CreatedByName}" 
                                                Width="120" />
                            
                            <DataGridTextColumn Header="Created At" 
                                                Binding="{Binding CreatedAt, StringFormat='{}{0:dd/MM/yyyy HH:mm}'}" 
                                                Width="140" />

                            <!-- Action Buttons Column -->
                            <DataGridTemplateColumn Header="Actions" Width="200">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <Button Content="Edit"
                                                    Command="{Binding DataContext.EditAdjustmentCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                    Background="{DynamicResource AccentBrush}"
                                                    Foreground="White"
                                                    Padding="8,4"
                                                    FontSize="11"
                                                    Margin="0,0,5,0"
                                                    IsEnabled="{Binding Status, Converter={StaticResource StringEqualityToBooleanConverter}, ConverterParameter='Pending'}" />
                                            
                                            <Button Content="Complete"
                                                    Command="{Binding DataContext.CompleteAdjustmentCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                    Background="{DynamicResource SuccessBrush}"
                                                    Foreground="White"
                                                    Padding="8,4"
                                                    FontSize="11"
                                                    Margin="0,0,5,0"
                                                    IsEnabled="{Binding Status, Converter={StaticResource StringEqualityToBooleanConverter}, ConverterParameter='Pending'}" />
                                            
                                            <Button Content="Delete"
                                                    Command="{Binding DataContext.DeleteAdjustmentCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                    Background="{DynamicResource DangerBrush}"
                                                    Foreground="White"
                                                    Padding="8,4"
                                                    FontSize="11"
                                                    IsEnabled="{Binding Status, Converter={StaticResource StringEqualityToBooleanConverter}, ConverterParameter='Pending'}" />
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>

                    <!-- Pagination -->
                    <Border Grid.Row="2" 
                            Background="{DynamicResource HeaderBackgroundBrush}"
                            Padding="15,10">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <!-- Page Info -->
                            <TextBlock Grid.Column="0"
                                       VerticalAlignment="Center"
                                       Foreground="{DynamicResource HeaderForegroundBrush}">
                                <Run Text="Page " />
                                <Run Text="{Binding CurrentPage}" />
                                <Run Text=" of " />
                                <Run Text="{Binding TotalPages}" />
                                <Run Text=" (" />
                                <Run Text="{Binding TotalCount}" />
                                <Run Text=" total records)" />
                            </TextBlock>

                            <!-- Navigation Buttons -->
                            <StackPanel Grid.Column="1" 
                                        Orientation="Horizontal">
                                <Button Content="Previous"
                                        Command="{Binding PreviousPageCommand}"
                                        IsEnabled="{Binding CurrentPage, Converter={StaticResource IntegerGreaterThanConverter}, ConverterParameter=1}"
                                        Background="{DynamicResource SecondaryBrush}"
                                        Foreground="White"
                                        Padding="10,5"
                                        Margin="0,0,5,0" />
                                
                                <Button Content="Next"
                                        Command="{Binding NextPageCommand}"
                                        IsEnabled="{Binding CurrentPage, Converter={StaticResource IntegerLessThanConverter}, ConverterParameter={Binding TotalPages}}"
                                        Background="{DynamicResource SecondaryBrush}"
                                        Foreground="White"
                                        Padding="10,5" />
                            </StackPanel>
                        </Grid>
                    </Border>
                </Grid>
            </Border>

            <!-- Edit/Create Adjustment Form -->
            <Border Background="{DynamicResource CardBackgroundBrush}"
                    BorderBrush="{DynamicResource BorderBrush}"
                    BorderThickness="1"
                    CornerRadius="5"
                    Visibility="{Binding IsEditing, Converter={StaticResource BooleanToVisibilityConverter}}"
                    Padding="20">
                
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <!-- Form Header -->
                    <TextBlock Grid.Row="0" 
                               Text="{Binding SelectedAdjustment, Converter={StaticResource NullToStringConverter}, ConverterParameter='New Stock Adjustment|Edit Stock Adjustment'}"
                               FontSize="18"
                               FontWeight="SemiBold"
                               Margin="0,0,0,20"
                               Foreground="{DynamicResource ForegroundBrush}" />

                    <!-- Form Fields -->
                    <Grid Grid.Row="1" Margin="0,0,0,20">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="200" />
                            <ColumnDefinition Width="20" />
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="200" />
                            <ColumnDefinition Width="20" />
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="200" />
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="15" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>

                        <!-- Adjustment Date -->
                        <TextBlock Grid.Row="0" Grid.Column="0" 
                                   Text="Date:" 
                                   VerticalAlignment="Center" 
                                   Foreground="{DynamicResource ForegroundBrush}" />
                        <DatePicker Grid.Row="0" Grid.Column="1" 
                                    SelectedDate="{Binding CurrentAdjustmentDto.AdjustmentDate}" />

                        <!-- Store Location -->
                        <TextBlock Grid.Row="0" Grid.Column="3" 
                                   Text="Store Location:" 
                                   VerticalAlignment="Center" 
                                   Foreground="{DynamicResource ForegroundBrush}" />
                        <ComboBox Grid.Row="0" Grid.Column="4" 
                                  ItemsSource="{Binding StoreLocations}"
                                  SelectedValue="{Binding CurrentAdjustmentDto.StoreLocationId}"
                                  SelectedValuePath="Id"
                                  DisplayMemberPath="Name" />

                        <!-- Reason -->
                        <TextBlock Grid.Row="0" Grid.Column="6" 
                                   Text="Reason:" 
                                   VerticalAlignment="Center" 
                                   Foreground="{DynamicResource ForegroundBrush}" />
                        <ComboBox Grid.Row="0" Grid.Column="7" 
                                  ItemsSource="{Binding AdjustmentReasons}"
                                  SelectedValue="{Binding CurrentAdjustmentDto.ReasonId}"
                                  SelectedValuePath="Id"
                                  DisplayMemberPath="Name" />

                        <!-- Notes -->
                        <TextBlock Grid.Row="2" Grid.Column="0" 
                                   Text="Notes:" 
                                   VerticalAlignment="Top" 
                                   Foreground="{DynamicResource ForegroundBrush}" />
                        <TextBox Grid.Row="2" Grid.Column="1" Grid.ColumnSpan="7"
                                 Text="{Binding CurrentAdjustmentDto.Notes}"
                                 Height="60"
                                 TextWrapping="Wrap"
                                 VerticalScrollBarVisibility="Auto" />
                    </Grid>

                    <!-- Items DataGrid - Placeholder for now -->
                    <Border Grid.Row="2" 
                            Background="{DynamicResource SecondaryBackgroundBrush}"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="1"
                            CornerRadius="3"
                            Padding="10">
                        <TextBlock Text="Stock Adjustment Items (TODO: Implement product selection and quantity entry)"
                                   FontStyle="Italic"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"
                                   Foreground="{DynamicResource MutedForegroundBrush}" />
                    </Border>

                    <!-- Form Action Buttons -->
                    <StackPanel Grid.Row="3" 
                                Orientation="Horizontal" 
                                HorizontalAlignment="Right"
                                Margin="0,20,0,0">
                        
                        <Button Content="Save"
                                Command="{Binding SaveAdjustmentCommand}"
                                Background="{DynamicResource SuccessBrush}"
                                Foreground="White"
                                Padding="20,8"
                                Margin="0,0,10,0" />
                        
                        <Button Content="Cancel"
                                Command="{Binding CancelEditCommand}"
                                Background="{DynamicResource SecondaryBrush}"
                                Foreground="White"
                                Padding="20,8" />
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Loading Overlay -->
            <Border Background="#80000000"
                    Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}">
                <StackPanel HorizontalAlignment="Center" 
                            VerticalAlignment="Center">
                    <ProgressBar IsIndeterminate="True" 
                                 Width="100" 
                                 Height="10" 
                                 Margin="0,0,0,10" />
                    <TextBlock Text="Loading..." 
                               Foreground="White" 
                               HorizontalAlignment="Center" />
                </StackPanel>
            </Border>
        </Grid>

    </Grid>

</UserControl>
